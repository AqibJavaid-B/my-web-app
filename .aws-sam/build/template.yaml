AWSTemplateFormatVersion: '2010-09-09'
Description: "DocChat \u2014 ECS (Fargate) web app using AWS Bedrock (ALB + ECR +\
  \ S3 + DynamoDB)"
Parameters:
  DocImageUri:
    Type: String
    Description: Full ECR image URI for DocChat (e.g. 123456789012.dkr.ecr.us-east-1.amazonaws.com/docchat-web:latest)
  DesiredCount:
    Type: Number
    Default: 2
  ContainerPort:
    Type: Number
    Default: 80
  BedrockModelId:
    Type: String
    Default: arn:aws:bedrock:us-east-1::foundation-model/openai.gpt-oss-120b-1:0
    Description: Bedrock model id used by the service (e.g. amazon.titan-text-001)
  DDBTableName:
    Type: String
    Default: docchat-conversations
  UploadBucketName:
    Type: String
    Default: docchat-uploads-bucket
  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
Resources:
  MyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:
        Ref: VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
      - Key: Name
        Value:
          Fn::Sub: ${AWS::StackName}-vpc
  InternetGateway:
    Type: AWS::EC2::InternetGateway
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: MyVPC
      InternetGatewayId:
        Ref: InternetGateway
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MyVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        Fn::Select:
        - 0
        - Fn::GetAZs: ''
      Tags:
      - Key: Name
        Value:
          Fn::Sub: ${AWS::StackName}-public-1
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MyVPC
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        Fn::Select:
        - 1
        - Fn::GetAZs: ''
      Tags:
      - Key: Name
        Value:
          Fn::Sub: ${AWS::StackName}-public-2
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MyVPC
      CidrBlock: 10.0.3.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone:
        Fn::Select:
        - 0
        - Fn::GetAZs: ''
      Tags:
      - Key: Name
        Value:
          Fn::Sub: ${AWS::StackName}-private-1
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: MyVPC
      CidrBlock: 10.0.4.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone:
        Fn::Select:
        - 1
        - Fn::GetAZs: ''
      Tags:
      - Key: Name
        Value:
          Fn::Sub: ${AWS::StackName}-private-2
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: MyVPC
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId:
        Ref: InternetGateway
  PublicSubnet1RouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnet1
      RouteTableId:
        Ref: PublicRouteTable
  PublicSubnet2RouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnet2
      RouteTableId:
        Ref: PublicRouteTable
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
        - NatGatewayEIP
        - AllocationId
      SubnetId:
        Ref: PublicSubnet1
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: MyVPC
  PrivateDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId:
        Ref: NatGateway
  PrivateSubnet1RouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnet1
      RouteTableId:
        Ref: PrivateRouteTable
  PrivateSubnet2RouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnet2
      RouteTableId:
        Ref: PrivateRouteTable
  UploadBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Ref: UploadBucketName
      VersioningConfiguration:
        Status: Suspended
  DocChatTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Ref: DDBTableName
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  DocChatEcrRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName:
        Fn::Sub: ${AWS::StackName}-docchat
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /ecs/${AWS::StackName}
      RetentionInDays: 14
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ecs-tasks.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ecs-tasks.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: DocChatTaskPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - bedrock-runtime:InvokeModel
            Resource: '*'
          - Effect: Allow
            Action:
            - s3:GetObject
            - s3:PutObject
            - s3:ListBucket
            Resource:
            - Fn::GetAtt:
              - UploadBucket
              - Arn
            - Fn::Sub: ${UploadBucket.Arn}/*
          - Effect: Allow
            Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Query
            - dynamodb:UpdateItem
            Resource:
            - Fn::GetAtt:
              - DocChatTable
              - Arn
          - Effect: Allow
            Action:
            - logs:CreateLogStream
            - logs:PutLogEvents
            - logs:CreateLogGroup
            Resource:
              Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/*
  AppCluster:
    Type: AWS::ECS::Cluster
  LoadBalancerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ALB security group
      VpcId:
        Ref: MyVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: '0.0.0.0/0'
  ContainerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ECS task security group
      VpcId:
        Ref: MyVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        SourceSecurityGroupId:
          Ref: LoadBalancerSG
  AppALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Subnets:
      - Ref: PublicSubnet1
      - Ref: PublicSubnet2
      SecurityGroups:
      - Ref: LoadBalancerSG
      Scheme: internet-facing
  AppTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Port:
        Ref: ContainerPort
      Protocol: HTTP
      VpcId:
        Ref: MyVPC
      TargetType: ip
      HealthCheckPath: /
  AppListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn:
        Ref: AppALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
      - Type: forward
        TargetGroupArn:
          Ref: AppTargetGroup
  DocChatTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Cpu: '512'
      Memory: '1024'
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
      ExecutionRoleArn:
        Fn::GetAtt:
        - ECSTaskExecutionRole
        - Arn
      TaskRoleArn:
        Fn::GetAtt:
        - ECSTaskRole
        - Arn
      ContainerDefinitions:
      - Name: docchat-web
        Image:
          Ref: DocImageUri
        Essential: true
        PortMappings:
        - ContainerPort:
            Ref: ContainerPort
        Environment:
        - Name: BEDROCK_MODEL_ID
          Value:
            Ref: BedrockModelId
        - Name: DDB_TABLE
          Value:
            Ref: DDBTableName
        - Name: S3_BUCKET
          Value:
            Ref: UploadBucketName
        - Name: AWS_DEFAULT_REGION
          Value:
            Ref: AWS::Region
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix:
              Fn::Sub: ${AWS::StackName}-web
  DocChatService:
    Type: AWS::ECS::Service
    DependsOn: AppListener
    Properties:
      ServiceName:
        Fn::Sub: ${AWS::StackName}-docchat-service
      Cluster:
        Ref: AppCluster
      LaunchType: FARGATE
      DesiredCount:
        Ref: DesiredCount
      TaskDefinition:
        Ref: DocChatTaskDefinition
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          Subnets:
          - Ref: PrivateSubnet1
          - Ref: PrivateSubnet2
          SecurityGroups:
          - Ref: ContainerSG
      LoadBalancers:
      - TargetGroupArn:
          Ref: AppTargetGroup
        ContainerName: docchat-web
        ContainerPort:
          Ref: ContainerPort
Outputs:
  EcrRepositoryUri:
    Description: ECR repo URI
    Value:
      Fn::GetAtt:
      - DocChatEcrRepo
      - RepositoryUri
  ALBUrl:
    Description: Application Load Balancer URL
    Value:
      Fn::Join:
      - ''
      - - http://
        - Fn::GetAtt:
          - AppALB
          - DNSName
  ClusterName:
    Description: ECS Cluster name
    Value:
      Ref: AppCluster
  ServiceName:
    Description: DocChat ECS service name
    Value:
      Ref: DocChatService
  UploadBucket:
    Description: S3 Bucket name for uploads
    Value:
      Ref: UploadBucket
  ConversationTable:
    Description: DynamoDB table name for conversation history
    Value:
      Ref: DocChatTable
